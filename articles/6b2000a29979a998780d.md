---
title: "ã¯ã˜ã‚ã¦ã®nest new"
emoji: "ğŸ˜½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nestjs"]
published: false
---

## ç›®çš„
ä»•äº‹ã§NestJSã‚’ä½¿ã†ã®ã§ã™ãŒè‡ªåˆ†ã§`nest new`ã—ãŸã“ã¨ç„¡ã‹ã£ãŸã®ã§å­¦ç¿’ã®æ„å‘³ã§ç°¡å˜ãªCRUDå‡¦ç†ã‚’ä½œæˆã—ãŸã®ã§ã€è¨˜éŒ²ã¨æ®‹ã—ã¦ç½®ã“ã†ã¨æ€ã„ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’åŸ·ã‚Šã¾ã—ãŸã€‚

## ç’°å¢ƒ
OSï¼šmacOS Big Sur 11.1
Nodeï¼šv14.4.0
NestJSï¼š7.5.4

## å°å…¥
```bash
npm i -g @nestjs/cli
```

## æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
```bash
nest new nestjs_todo
```

## å¿…è¦ãªã‚‚ã®ã‚’å°å…¥
```bash
npm i @nestjs/typeorm typeorm mysql2 class-transformer class-validator
```

## ormconfig.jsonã‚’ä½œæˆ

```json:ormconfig.json
{
  "name": "default",
  "type": "mysql",
  "host": "localhost",
  "port": 3306,
  "username": "root",
  "password": "",
  "database": "nest",
  "synchronize": true,
  "logging": true,
  "entities": [
    "dist/entities/**/*.entity.js"
  ],
  "migrations": [
    "dist/migrations/**/*.js"
  ]
}
```

## Entityãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
```ts:src/entities/task.entity.ts 
import {
  Entity,
  Column,
  PrimaryGeneratedColumn,
  CreateDateColumn,
  UpdateDateColumn,
} from "typeorm";

@Entity()
export class Task {
  @PrimaryGeneratedColumn()
  readonly id: number;

  @Column()
  title: string;

  @CreateDateColumn()
  readonly createdAt?: Date;

  @UpdateDateColumn()
  readonly updatedAt?: Date;
}
```

## migrationãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```bash
npx typeorm migration:generate -d src/migrations -n create-task
```

```ts:src/migrations/1608641968685-create-task.ts
import {MigrationInterface, QueryRunner} from "typeorm";

export class createTask1608641968685 implements MigrationInterface {
    name = 'createTask1608641968685'

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query("CREATE TABLE `task` (`id` int NOT NULL AUTO_INCREMENT, `title` varchar(255) NOT NULL, `createdAt` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6), `updatedAt` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6), PRIMARY KEY (`id`)) ENGINE=InnoDB");
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query("DROP TABLE `task`");
    }

}
```

## migrationå®Ÿè¡Œ
```bash
npx typeorm migration:run
```

## Controllerä½œæˆ
```bash
nest g controller tasks
```

```ts:src/tasks/tasks.controller.ts
import { Controller } from '@nestjs/common';

@Controller('tasks')
export class TasksController {}
```

## Serviceä½œæˆ
```bash
nest g service tasks
```

```ts:src/tasks/tasks.service.ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class TasksService {}
```

## Moduleä½œæˆ
```bash
nest g module tasks
```

```ts:src/tasks/tasks.module.ts
import { Module } from '@nestjs/common';

@Module({})
export class TasksModule {}
```

## Readå‡¦ç†ã‚’å®Ÿè£…
```ts:src/tasks/tasks.controller.ts
import { Controller, Get } from '@nestjs/common';
import { Task } from 'src/entities/task.entity';
import { TasksService } from './tasks.service'

@Controller('tasks')
export class TasksController {
  constructor(private readonly taskService: TasksService) {}

  @Get()
  async findAll(): Promise<Task[]> {
    return await this.taskService.findAll()
  }
}
```

```ts:src/tasks/tasks.module.ts
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Task } from 'src/entities/task.entity';
import { TasksController } from './tasks.controller';
import { TasksService } from './tasks.service';

@Module({
  controllers: [TasksController],
  imports: [TypeOrmModule.forFeature([Task])],
  providers: [TasksService],
  exports: [TypeOrmModule],
})
export class TasksModule {}
```

```ts:src/tasks/tasks.service.ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Task } from 'src/entities/task.entity';
import { Repository } from 'typeorm';

@Injectable()
export class TasksService {
  constructor(
    @InjectRepository(Task)
    private readonly taskRepository: Repository<Task>
  ) {}

  async findAll(): Promise<Task[]> {
    return await this.taskRepository.find()
  }
}
```

## Createå‡¦ç†ã‚’å®Ÿè£…
```ts:src/dto/create-task.dto.ts
import { IsNotEmpty, IsString } from "class-validator";

export class CreateTaskDTO {
  @IsNotEmpty()
  @IsString()
  title: string;
}
```

```ts:src/main.ts
import { ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // è¿½åŠ 
  app.useGlobalPipes(new ValidationPipe());
  await app.listen(3000);
}
bootstrap();
```

```ts:src/tasks/tasks.controller.ts
@Post()
async create(@Body() createTaskDto: CreateTaskDTO) {
  return await this.taskService.create(createTaskDto)
}
```

```ts:src/tasks/tasks.service.ts
async create(task: CreateTaskDTO): Promise<InsertResult> {
  return await this.taskRepository.insert(task)
}
```

## Updateå‡¦ç†ã‚’å®Ÿè£…
```ts:src/dto/update-task.dto.ts
import { IsNotEmpty, IsString } from "class-validator";

export class UpdateTaskDto {
  @IsNotEmpty()
  @IsString()
  title: string;
}
```

```ts:src/tasks/tasks.controller.ts
@Put(':id')
async update(@Param('id') id: string, @Body() updateTaskDto: UpdateTaskDto) {
  return await this.taskService.update(+id, updateTaskDto)
}
```

```ts:src/tasks/tasks.service.ts
async update(id: number, updateTaskDto: UpdateTaskDto) {
  return await this.taskRepository.update(id, updateTaskDto)
}
```

## Deleteå‡¦ç†ã‚’å®Ÿè£…
```ts:src/tasks/tasks.controller.ts
@Delete(':id')
async remove(@Param('id') id: string) {
  return this.taskService.remove(+id)
}
```

```ts:src/tasks/tasks.service.ts
async remove(id: number) {
  return await this.taskRepository.delete(id)
}
```

## æ„Ÿæƒ³
0ã‹ã‚‰è‡ªåˆ†ã§ã‚„ã£ã¦ã¿ã‚‹ã¨ã„ã†ã®ã¯å¤§å¤‰ãªéƒ¨åˆ†ã‚‚ã‚ã‚Šã¾ã—ãŸãŒæ–°ãŸãªçŸ¥è­˜ã‚’å¢—ã‚„ã™ã“ã¨ãŒå‡ºæ¥ã¾ã—ãŸã€‚ãã—ã¦ã€å…¬å¼ã‚µã‚¤ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®åˆ†ã‹ã‚Šã‚„ã™ã•ã‚’å†å®Ÿæ„Ÿã—ã¾ã—ãŸã€‚
ã‚³ãƒ¼ãƒ‰å…¨ä½“ã¯ä¸‹è¨˜ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã§ç¢ºèªå‡ºæ¥ã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚ 
https://github.com/youheiyouhei/nestjs_todo

## å‚è€ƒ
https://docs.nestjs.com
https://github.com/typeorm/typeorm
